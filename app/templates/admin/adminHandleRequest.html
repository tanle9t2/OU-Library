{% extends 'admin/layout/base.html' %}
{% block title %} Thống kê doanh thu {% endblock %}
{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/adminStatistic.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/adminStatistic.css') }}">
{% endblock %}
{% block js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/handleBorrowing.js') }}"></script>
{% endblock %}

{% block content %}
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4" style="display: flex; width: 100%;">
                <!-- Div 1: 23% -->
                <div class="col-lg-6 col-7" style="flex: 0 0 23%; max-width: 23%;">
                    <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                        <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                            <li class="breadcrumb-item"><a href="/admin/statistic-revenue"><i
                                    class="fas fa-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="/admin/statistic-revenue">Duyệt yêu cầu</a>
                            </li>
                        </ol>
                    </nav>
                </div>


                <!-- Div 2: 59% -->
                <div class="col-lg-6 col-7" style="flex: 0 0 40%; max-width: 40%;padding:0;">
                    <form class="col-lg-6 col-7" style="display: flex; gap: 10px; align-items: center;padding:0;"
                          id="month-form"
                          method="GET">
                        <div style="flex: 1;">
                            <input type="month" name="date" style="width: 100%; box-sizing: border-box;"
                                   onchange="this.form.submit()" value="{{ request.args.get('date') }}">
                        </div>
                        <div
                                style="flex: 1;"
                                class="btn-group rounded-sm bg-white">
                            <button type="button" class="btn btn-outline-dark dropdown-toggle
                                     dropdown-toggle-order"
                                    data-toggle="dropdown">
                                {% if order == 'latest' %}
                                Mới nhất
                                {% elif order == 'oldest' %}
                                Cũ nhất
                                {% else %}
                                Mới nhất
                                {% endif %}
                            </button>
                            <div class="dropdown-menu dropdown-menu-order custom-dropdown-menu">
                                <span class="dropdown-item" value="latest">Mới nhất</span>
                                <span class="dropdown-item" value="oldest">Cũ nhất</span>
                            </div>
                        </div>
                    </form>
                </div>


            </div>

        </div>
    </div>
</div>
<!-- Page content -->
<div class="container-fluid mt--6" id="statistic-table" style="display: block;">
    <div class="row justify-content-center">
        <div class=" col ">
            <div class="card" style="margin-bottom: 0">
                <div class="card-header bg-transparent" style="display: flex; justify-content: space-between">
                    <h3 class="mb-0">Danh sách yêu cầu mượn sách</h3>
                    {% if request_borrowing['pages'] > 1 %}
                    <ul class="pagination" style="margin: 0; display: flex; justify-content: center;">
                        <!-- Nút Previous -->
                        <li class="page-item{% if request_borrowing['current_page'] == 1 %} disabled {% endif %}">
                            <a class="page-link"
                               href="?page={{ prevPage }}{% if request.args.get('date') %}&selected_month={{ request.args.get('date') }}{% endif %}
{% if request.args.get('order') %}&order={{ request.args.get('order') }}{% endif %}"
                               tabindex="-1">
                                <i class="fas fa-angle-left"></i>
                                <span class="sr-only">Previous</span>
                            </a>
                        </li>

                        <!-- Hiển thị các trang -->
                        {% for page in range(1,request_borrowing['pages']+1) %}
                        <li class="page-item{% if page == request_borrowing['current_page'] %} active {% endif %}">
                            <a class="page-link"
                               href="?page={{ page }}{% if request.args.get('date') %}&selected_month={{ request.args.get('date') }}{% endif %}
{% if request.args.get('order') %}&order={{ request.args.get('order') }}{% endif %}">
                                {{ page }}
                            </a>
                        </li>
                        {% endfor %}

                        <!-- Nút Next -->
                        <li class="page-item{% if request_borrowing['current_page'] == request_borrowing['pages'] %} disabled {% endif %}">
                            <a class="page-link"
                               href="?page={{ nextPage }}{% if request.args.get('date') %}&selected_month={{ request.args.get('date') }}{% endif %}
{% if request.args.get('order') %}&order={{ request.args.get('order') }}{% endif %}">

                                <i class="fas fa-angle-right"></i>
                                <span class="sr-only">Next</span>
                            </a>
                        </li>
                    </ul>
                    {% endif %}

                </div>
                {% if request_borrowing['request'] | length > 0 %}
                <div class="card-body" style="padding-top: 0">
                    <div class="row icon-examples">
                        <div class="col-12">
                            <div class="table-responsive"
                                 style="overflow-y: auto; border: 1px solid #adb5bd; border-radius: 5px;">


                                <table class="table align-items-center table-flush"
                                       style="border-collapse: collapse; width: 100%; border: 1px solid #adb5bd;">

                                    <!-- Define column widths -->
                                    <colgroup>
                                        <col style="width: 15%;"> <!-- Mã yêu cầu -->
                                        <col style="width: 25%;"> <!-- Tên sách -->
                                        <col style="width: 20%;"> <!-- Người yêu cầu -->
                                        <col style="width: 20%;"> <!-- Ngày yêu cầu -->
                                        <col style="width: 20%;"> <!-- Hành động -->
                                    </colgroup>

                                    <thead class="thead-light" style="position: sticky; top: 0; z-index: 1;">
                                    <tr>
                                        <th class="text-center"
                                            style="border: 1px solid #adb5bd; background-color: #c92127; color: #ffffff;">
                                            Mã yêu cầu
                                        </th>
                                        <th class="text-center"
                                            style="border: 1px solid #adb5bd; background-color: #c92127; color: #ffffff;">
                                            Tên sách
                                        </th>
                                        <th class="text-center"
                                            style="border: 1px solid #adb5bd; background-color: #c92127; color: #ffffff;">
                                            Người yêu cầu
                                        </th>
                                        <th class="text-center"
                                            style="border: 1px solid #adb5bd; background-color: #c92127; color: #ffffff;">
                                            Ngày yêu cầu
                                        </th>
                                        <th class="text-center"
                                            style="border: 1px solid #adb5bd; background-color: #c92127; color: #ffffff;">
                                            Hành động
                                        </th>
                                    </tr>
                                    </thead>

                                    <tbody class="list">
                                    {% for s in request_borrowing['request'] %}
                                    <tr class="book-row">
                                        <td class="text-center"
                                            style="border: 1px solid #adb5bd; white-space: normal; word-break: break-word;">
                                            {{ s.book_request_id
                                            }}
                                        </td>
                                        <td class="text-center"
                                            style="border: 1px solid #adb5bd; white-space: normal; word-break: break-word;">
                                            {{ s.book.title }}
                                        </td>
                                        <td class="text-center"
                                            style="border: 1px solid #adb5bd; white-space: normal; word-break: break-word;">
                                            {{ s.user.full_name
                                            }}
                                        </td>
                                        <td class="text-center"
                                            style="border: 1px solid #adb5bd; white-space: normal; word-break: break-word;">
                                            {{ s.created_at }}
                                        </td>
                                        <td class="text-center" style="border: 1px solid #adb5bd;">
                                            <form action="/employee/accept-request/{{ s.book_request_id }}"
                                                  method="POST" style="display:inline;">
                                                <button type="submit" class="btn btn-success">Chấp nhận</button>
                                            </form>
                                            <button class="cancel-btn btn btn-danger">Hủy</button>
                                            <div class="modal-overlay cancel-form" id="modalOverlay">
                                                <form action="/employee/cancel-request/{{ s.book_request_id }}"
                                                      method="POST"
                                                      class="modal-container" onclick="event.stopPropagation()">
                                                    <div class="modal-header">Lý do hủy</div>
                                                    <textarea class="w-100" name="note"
                                                              placeholder="Nhập lý do hủy yêu cầu"></textarea>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn-undo">Hủy</button>
                                                        <button type="submit" class="btn-confirm">Xác nhận</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>


                            </div>
                        </div>
                    </div>
                </div>
                {%else%}
                <p class="text-center font-weight-bold">Không có yêu cầu nào</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}